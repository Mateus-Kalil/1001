<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Terminal Debian Interativo</title>
    <style>
        :root {
            --bg-color: #0a0b0c;
            --terminal-bg: #000000;
            --terminal-text: #00ff00;
            --terminal-prompt: #00ff00;
            --terminal-success: #00ff00;
            --terminal-error: #ff0000;
            --glow-color: rgba(0, 255, 0, 0.5);
            --terminal-width: 800px;
            --terminal-height: 500px;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            font-family: monospace;
            color: var(--terminal-text);
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 30% 40%, rgba(0, 100, 0, 0.1) 0%, transparent 40%),
                radial-gradient(circle at 70% 60%, rgba(0, 100, 0, 0.1) 0%, transparent 40%);
            z-index: -1;
        }

        .grid {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(0, 50, 0, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 50, 0, 0.1) 1px, transparent 1px);
            background-size: 20px 20px;
            z-index: -1;
        }

        .floating-text {
            position: absolute;
            color: rgba(0, 255, 0, 0.2);
            font-family: monospace;
            font-size: 14px;
            pointer-events: none;
            z-index: -1;
        }

        .particles {
            position: absolute;
            width: 100%;
            height: 100%;
            z-index: -1;
        }

        .particle {
            position: absolute;
            width: 2px;
            height: 2px;
            background-color: rgba(0, 255, 0, 0.4);
            border-radius: 50%;
        }

        .container {
            position: relative;
            width: calc(var(--terminal-width) + 40px);
            margin: 20px auto;
            z-index: 1;
        }

        .terminal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(to right, #111, #222);
            padding: 5px 10px;
            border-top-left-radius: 10px;
            border-top-right-radius: 10px;
            border: 1px solid #444;
            border-bottom: none;
        }

        .terminal-title {
            font-size: 14px;
            color: #ddd;
        }

        .terminal-controls {
            display: flex;
            gap: 5px;
        }

        .control-btn {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: none;
        }

        .control-btn.close {
            background-color: #ff5f57;
        }

        .control-btn.minimize {
            background-color: #ffbd2e;
        }

        .control-btn.maximize {
            background-color: #28ca41;
        }

        .terminal-window {
            position: relative;
            width: var(--terminal-width);
            height: var(--terminal-height);
            background-color: var(--terminal-bg);
            border-radius: 0 0 10px 10px;
            box-shadow: 0 0 20px var(--glow-color);
            overflow: hidden;
            border: 1px solid #444;
            animation: boot 2s ease-out;
        }

        .terminal {
            width: 100%;
            height: 100%;
            padding: 10px;
            box-sizing: border-box;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.4;
            color: var(--terminal-text);
            text-shadow: 0 0 5px rgba(0, 255, 0, 0.5);
        }

        .terminal-input {
            background: transparent;
            border: none;
            outline: none;
            color: var(--terminal-text);
            font-family: 'Courier New', monospace;
            font-size: 14px;
            width: calc(100% - 150px);
            text-shadow: 0 0 5px rgba(0, 255, 0, 0.5);
        }

        .terminal-line {
            white-space: pre-wrap;
            word-break: break-all;
            margin: 2px 0;
        }

        .prompt {
            color: var(--terminal-prompt);
        }

        .success {
            color: var(--terminal-success);
        }

        .error {
            color: var(--terminal-error);
        }

        .scan-line {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background-color: rgba(0, 255, 0, 0.1);
            animation: scan 6s linear infinite;
            pointer-events: none;
        }

        .crt-effect {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(rgba(0, 0, 0, 0.1) 50%, rgba(0, 0, 0, 0.15) 50%);
            background-size: 100% 4px;
            pointer-events: none;
        }

        .flicker {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 50, 0, 0.03);
            opacity: 0;
            pointer-events: none;
            animation: flicker 0.3s infinite;
        }

        .blinking-cursor {
            display: inline-block;
            width: 8px;
            height: 16px;
            background-color: var(--terminal-text);
            animation: blink 1s infinite;
            vertical-align: middle;
        }

        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background-color: rgba(0, 20, 0, 0.5);
            border-radius: 10px;
            margin-top: 20px;
            box-shadow: 0 0 10px var(--glow-color);
        }

        .tty-selection {
            display: flex;
            gap: 10px;
        }

        .tty-btn {
            background: #111;
            color: #00ff00;
            border: 1px solid #00aa00;
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
            font-family: monospace;
            transition: all 0.2s;
        }

        .tty-btn:hover, .tty-btn.active {
            background: #00aa00;
            color: #000;
        }

        .save-controls {
            display: flex;
            gap: 10px;
        }

        .save-toggle {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .save-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .save-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #333;
            transition: .4s;
            border-radius: 24px;
        }

        .save-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .save-slider {
            background-color: #00aa00;
        }

        input:checked + .save-slider:before {
            transform: translateX(26px);
        }

        .btn {
            background: #111;
            color: #00ff00;
            border: 1px solid #00aa00;
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
            font-family: monospace;
            transition: all 0.2s;
        }

        .btn:hover {
            background: #00aa00;
            color: #000;
        }

        .save-label {
            font-size: 12px;
            color: #00ff00;
        }

        .footer {
            position: absolute;
            bottom: 10px;
            text-align: center;
            color: #00aa00;
            font-size: 12px;
            width: 100%;
            z-index: 10;
        }

        /* Loading spinner */
        .loading {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(0, 255, 0, 0.3);
            border-radius: 50%;
            border-top: 4px solid #00ff00;
            animation: spin 1s linear infinite;
        }

        /* Animações */
        @keyframes boot {
            0% {
                opacity: 0;
                filter: brightness(2);
            }
            20% {
                opacity: 0.7;
                filter: brightness(2);
            }
            30% {
                opacity: 0.5;
                filter: brightness(1);
            }
            40% {
                opacity: 0.8;
                filter: brightness(1.5);
            }
            50% {
                opacity: 0.6;
                filter: brightness(1);
            }
            100% {
                opacity: 1;
                filter: brightness(1);
            }
        }

        @keyframes scan {
            0% {
                top: 0%;
            }
            100% {
                top: 100%;
            }
        }

        @keyframes blink {
            0%, 49% {
                opacity: 1;
            }
            50%, 100% {
                opacity: 0;
            }
        }

        @keyframes flicker {
            0%, 100% {
                opacity: 0;
            }
            50% {
                opacity: 1;
            }
        }

        @keyframes float {
            0% {
                transform: translateY(0px);
            }
            50% {
                transform: translateY(-10px);
            }
            100% {
                transform: translateY(0px);
            }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Efeitos de distorção do monitor */
        .glitch {
            animation: glitch 5s infinite;
        }

        @keyframes glitch {
            0%, 95%, 100% {
                transform: skew(0deg);
                filter: brightness(1);
            }
            96% {
                transform: skew(2deg);
                filter: brightness(1.2);
            }
            97% {
                transform: skew(-2deg);
                filter: brightness(0.8);
            }
            98% {
                transform: skew(1deg);
                filter: brightness(1.1);
            }
            99% {
                transform: skew(-1deg);
                filter: brightness(0.9);
            }
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #0a0b0c;
            padding: 20px;
            border-radius: 10px;
            width: 80%;
            max-width: 600px;
            max-height: 80%;
            overflow-y: auto;
            border: 1px solid #00aa00;
            box-shadow: 0 0 20px var(--glow-color);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 1px solid #00aa00;
            padding-bottom: 10px;
        }

        .modal-title {
            color: #00ff00;
            font-size: 18px;
        }

        .close-modal {
            color: #00ff00;
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
        }

        .history-item {
            padding: 10px;
            margin: 5px 0;
            background-color: #111;
            border-radius: 5px;
            cursor: pointer;
            border: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .history-item:hover {
            background-color: #222;
            border-color: #00aa00;
        }

        .history-name {
            color: #00ff00;
        }

        .history-date {
            color: #888;
            font-size: 12px;
        }

        .delete-history {
            color: #ff0000;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
        }

        .no-history {
            color: #888;
            text-align: center;
            padding: 20px;
        }
    </style>
</head>
<body>
    <div class="background"></div>
    <div class="grid"></div>
    <div class="particles" id="particles"></div>

    <div class="container">
        <div class="terminal-header">
            <div class="terminal-controls">
                <button class="control-btn close"></button>
                <button class="control-btn minimize"></button>
                <button class="control-btn maximize"></button>
            </div>
            <div class="terminal-title">Terminal Debian</div>
            <div></div>
        </div>
        <div class="terminal-window">
            <div class="scan-line"></div>
            <div class="crt-effect"></div>
            <div class="flicker"></div>
            <div class="terminal" id="terminal">
                <!-- Conteúdo do terminal será adicionado aqui -->
            </div>
            <div class="loading" id="loading">
                <div class="spinner"></div>
            </div>
        </div>
    </div>

    <div class="controls">
        <div class="tty-selection">
            <button class="tty-btn active" data-tty="1">TTY1</button>
            <button class="tty-btn" data-tty="2">TTY2</button>
            <button class="tty-btn" data-tty="3">TTY3</button>
            <button class="tty-btn" data-tty="4">TTY4</button>
            <button class="tty-btn" data-tty="5">TTY5</button>
            <button class="tty-btn" data-tty="6">TTY6</button>
        </div>
        <div class="save-controls">
            <div>
                <label class="save-toggle">
                    <input type="checkbox" id="autoSaveToggle">
                    <span class="save-slider"></span>
                </label>
                <span class="save-label">Auto-salvar</span>
            </div>
            <button class="btn" id="saveBtn">Salvar</button>
            <button class="btn" id="loadBtn">Carregar</button>
            <button class="btn" id="resetBtn">Resetar</button>
        </div>
    </div>

    <div class="modal" id="historyModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Histórico de Sessões</div>
                <button class="close-modal" id="closeModal">&times;</button>
            </div>
            <div id="historyList">
                <!-- Os itens do histórico serão adicionados aqui -->
            </div>
        </div>
    </div>

    <div class="footer">
        &copy; 2025 MKalil - Terminal Debian Interativo
    </div>

    <script>
        // Sistema de arquivos simulado
        const filesystem = {
            '/': {
                type: 'd',
                permissions: 'drwxr-xr-x',
                owner: 'root',
                group: 'root',
                content: {},
                date: '2025-05-15 08:00'
            }
        };

        // Inicializar sistema de arquivos padrão
        const defaultDirs = [
            'boot', 'bin', 'dev', 'etc', 'home', 'lib', 'media', 
            'mnt', 'opt', 'proc', 'root', 'sbin', 'srv', 'sys', 
            'tmp', 'usr', 'var'
        ];

        // Função para criar estrutura inicial do sistema de arquivos
        function initializeFilesystem() {
            defaultDirs.forEach(dir => {
                filesystem['/'][dir] = {
                    type: 'd',
                    permissions: 'drwxr-xr-x',
                    owner: 'root',
                    group: 'root',
                    content: {},
                    date: '2025-05-15 08:00'
                };
            });

            // Adicionar alguns arquivos básicos
            filesystem['/']['etc']['passwd'] = {
                type: '-',
                permissions: '-rw-r--r--',
                owner: 'root',
                group: 'root',
                content: 'root:x:0:0:root:/root:/bin/bash\nnobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin',
                date: '2025-05-15 08:00'
            };

            filesystem['/']['etc']['hostname'] = {
                type: '-',
                permissions: '-rw-r--r--',
                owner: 'root',
                group: 'root',
                content: 'debian',
                date: '2025-05-15 08:00'
            };

            filesystem['/']['home']['user'] = {
                type: 'd',
                permissions: 'drwxr-xr-x',
                owner: 'user',
                group: 'user',
                content: {},
                date: '2025-05-15 08:00'
            };

            // Criar arquivo sources.list
            filesystem['/']['etc']['apt'] = {
                type: 'd',
                permissions: 'drwxr-xr-x',
                owner: 'root',
                group: 'root',
                content: {},
                date: '2025-05-15 08:00'
            };

            filesystem['/']['etc']['apt']['sources.list'] = {
                type: '-',
                permissions: '-rw-r--r--',
                owner: 'root',
                group: 'root',
                content: 'deb http://deb.debian.org/debian bookworm main',
                date: '2025-05-15 08:00'
            };

            filesystem['/']['etc']['network'] = {
                type: 'd',
                permissions: 'drwxr-xr-x',
                owner: 'root',
                group: 'root',
                content: {},
                date: '2025-05-15 08:00'
            };

            filesystem['/']['etc']['network']['interfaces'] = {
                type: '-',
                permissions: '-rw-r--r--',
                owner: 'root',
                group: 'root',
                content: '# This file describes the network interfaces available on your system\n# and how to activate them. For more information, see interfaces(5).\n\nsource /etc/network/interfaces.d/*\n\n# The loopback network interface\nauto lo\niface lo inet loopback\n\n# The primary network interface\nallow-hotplug enp0s3\niface enp0s3 inet dhcp',
                date: '2025-05-15 08:00'
            };
        }

        // Pacotes disponíveis
        const availablePackages = {
            'vim': {
                version: '8.2.3995',
                size: '3.2MB',
                description: 'Vi IMproved - enhanced vi editor',
                installed: false,
                dependencies: []
            },
            'nano': {
                version: '6.4',
                size: '1.5MB',
                description: 'small, friendly text editor inspired by Pico',
                installed: false,
                dependencies: []
            },
            'apache2': {
                version: '2.4.56',
                size: '8.5MB',
                description: 'Apache HTTP Server',
                installed: false,
                dependencies: ['libapache2-mod-php']
            },
            'php': {
                version: '8.2.0',
                size: '5.2MB',
                description: 'server-side, HTML-embedded scripting language',
                installed: false,
                dependencies: []
            },
            'libapache2-mod-php': {
                version: '8.2.0',
                size: '3.4MB',
                description: 'server-side, HTML-embedded scripting language (Apache 2 module)',
                installed: false,
                dependencies: ['php']
            },
            'mysql-server': {
                version: '8.0.32',
                size: '12.7MB',
                description: 'MySQL database server',
                installed: false,
                dependencies: []
            },
            'nginx': {
                version: '1.22.1',
                size: '7.8MB',
                description: 'small, powerful, scalable web/proxy server',
                installed: false,
                dependencies: []
            },
            'python3': {
                version: '3.11.2',
                size: '4.6MB',
                description: 'interactive high-level object-oriented language',
                installed: false,
                dependencies: []
            },
            'git': {
                version: '2.39.2',
                size: '9.3MB',
                description: 'fast, scalable, distributed revision control system',
                installed: false,
                dependencies: []
            },
            'openssh-server': {
                version: '9.2p1',
                size: '2.8MB',
                description: 'secure shell (SSH) server, for secure access from remote machines',
                installed: false,
                dependencies: []
            },
            'nodejs': {
                version: '18.13.0',
                size: '11.2MB',
                description: 'evented I/O for V8 javascript - runtime executable',
                installed: false,
                dependencies: []
            },
            'curl': {
                version: '7.88.1',
                size: '1.2MB',
                description: 'command line tool for transferring data with URL syntax',
                installed: false,
                dependencies: []
            },
            'wget': {
                version: '1.21.3',
                size: '2.1MB',
                description: 'retrieves files from the web',
                installed: false,
                dependencies: []
            }
        };

        // Inicializa as TTYs
        const ttys = {
            1: { history: [], currentDir: '/root', user: 'root', hostname: 'debian', output: [] },
            2: { history: [], currentDir: '/root', user: 'root', hostname: 'debian', output: [] },
            3: { history: [], currentDir: '/root', user: 'root', hostname: 'debian', output: [] },
            4: { history: [], currentDir: '/root', user: 'root', hostname: 'debian', output: [] },
            5: { history: [], currentDir: '/root', user: 'root', hostname: 'debian', output: [] },
            6: { history: [], currentDir: '/root', user: 'root', hostname: 'debian', output: [] }
        };

        // Estado atual do sistema
        let currentState = {
            currentTTY: 1,
            networkInterfaces: {
                lo: {
                    status: 'up',
                    address: '127.0.0.1',
                    netmask: '255.0.0.0'
                },
                enp0s3: {
                    status: 'up',
                    address: '10.0.2.15',
                    netmask: '255.255.255.0'
                },
                enp0s8: {
                    status: 'down',
                    address: '',
                    netmask: ''
                }
            },
            runningProcesses: [],
            installedPackages: {},
            users: {
                'root': {
                    password: 'x',
                    uid: 0,
                    gid: 0,
                    home: '/root',
                    shell: '/bin/bash'
                },
                'user': {
                    password: 'x',
                    uid: 1000,
                    gid: 1000,
                    home: '/home/user',
                    shell: '/bin/bash'
                }
            },
            currentUser: 'root',
            hostname: 'debian',
            uptime: 0,
            bootTime: new Date().getTime(),
            kernel: {
                version: '5.10.0-21-amd64',
                status: 'running'
            },
            grub: {
                status: 'healthy',
                config: 'default'
            },
            aptUpdated: false
        };

        // Elementos DOM
        const terminal = document.getElementById('terminal');
        const loadingElement = document.getElementById('loading');
        const ttyButtons = document.querySelectorAll('.tty-btn');
        const autoSaveToggle = document.getElementById('autoSaveToggle');
        const saveBtn = document.getElementById('saveBtn');
        const loadBtn = document.getElementById('loadBtn');
        const resetBtn = document.getElementById('resetBtn');
        const historyModal = document.getElementById('historyModal');
        const historyList = document.getElementById('historyList');
        const closeModal = document.getElementById('closeModal');

        // Variáveis de controle
        let isExecuting = false;
        let currentInput = '';
        let inputPosition = 0;
        let inputHistory = [];
        let historyPosition = -1;
        let autoSave = false;
        let activeEditor = null;

        // Inicialização
        window.onload = function() {
            initializeFilesystem();
            renderTerminal();
            createParticles();
            createFloatingText();
            
            // Verificar se existe algum estado salvo
            autoSaveToggle.checked = localStorage.getItem('debianTerminalAutoSave') === 'true';
            autoSave = autoSaveToggle.checked;
            
            if (autoSave && localStorage.getItem('debianTerminalState')) {
                try {
                    const savedState = JSON.parse(localStorage.getItem('debianTerminalState'));
                    restoreState(savedState);
                } catch (e) {
                    console.error('Erro ao restaurar estado:', e);
                }
            } else {
                // Iniciar com mensagem de boot
                bootSystem();
            }
        };

        // Função para criar partículas flutuantes
        function createParticles() {
            const particlesContainer = document.getElementById('particles');
            const numParticles = 50;
            
            for (let i = 0; i < numParticles; i++) {
                const particle = document.createElement('div');
                particle.classList.add('particle');
                
                // Posição aleatória
                const x = Math.random() * 100;
                const y = Math.random() * 100;
                
                particle.style.left = `${x}%`;
                particle.style.top = `${y}%`;
                
                // Animação aleatória
                const duration = 3 + Math.random() * 7;
                const delay = Math.random() * 5;
                
                particle.style.animation = `float ${duration}s ease-in-out ${delay}s infinite`;
                particle.style.opacity = 0.2 + Math.random() * 0.3;
                
                particlesContainer.appendChild(particle);
            }
        }

        // Função para criar texto flutuante
        function createFloatingText() {
            const container = document.body;
            const terms = [
                'sudo', 'apt', 'ls -la', 'chmod', 'grep', 'awk', 'sed',
                'systemctl', 'journalctl', 'cat', 'find', 'cd', 'mv',
                'cp', 'mkdir', 'rm -rf', 'ifconfig', 'ssh', 'tar', 'wget'
            ];
            
            for (let i = 0; i < 15; i++) {
                const floatingText = document.createElement('div');
                floatingText.classList.add('floating-text');
                
                const x = Math.random() * 100;
                const y = Math.random() * 100;
                floatingText.style.left = `${x}%`;
                floatingText.style.top = `${y}%`;
                
                const term = terms[Math.floor(Math.random() * terms.length)];
                floatingText.textContent = term;
                
                const duration = 10 + Math.random() * 20;
                const delay = Math.random() * 5;
                floatingText.style.animation = `float ${duration}s ease-in-out ${delay}s infinite`;
                
                container.appendChild(floatingText);
            }
        }

        // Simula o processo de boot do sistema
        function bootSystem() {
            const bootMessages = [
                { text: 'Booting Debian GNU/Linux...', delay: 500 },
                { text: 'Loading Linux 5.10.0-21-amd64...', delay: 800 },
                { text: 'Loading initial ramdisk...', delay: 1000 },
                { text: 'Starting systemd...', delay: 500 },
                { text: 'Starting Journal Service...', delay: 300 },
                { text: 'Starting Device-mapper event daemon...', delay: 200 },
                { text: 'Starting Network Manager...', delay: 400 },
                { text: 'Starting Login Service...', delay: 300 },
                { text: 'Reached target Basic System.', delay: 200 },
                { text: 'Reached target Graphical Interface.', delay: 500 },
                { text: 'Starting GNOME Display Manager...', delay: 400 },
                { text: 'Debian GNU/Linux 12 debian tty1', delay: 800 },
                { text: '', delay: 300 },
                { text: 'debian login: root', delay: 500 },
                { text: 'Password: ********', delay: 500 },
                { text: '', delay: 300 },
                { text: 'Last login: Sun Jun 01 08:30:45 UTC 2025 from localhost', delay: 300 }
            ];
            
            let totalDelay = 0;
            
            bootMessages.forEach((msg, index) => {
                totalDelay += msg.delay;
                setTimeout(() => {
                    addOutput(msg.text, 'boot');
                    
                    // Se for o último, renderize o prompt
                    if (index === bootMessages.length - 1) {
                        renderPrompt();
                    }
                }, totalDelay);
            });
        }

        // Manipulação do terminal
        function renderTerminal() {
            terminal.innerHTML = '';
            
            // Adicionar linhas de saída
            ttys[currentState.currentTTY].output.forEach(line => {
                const lineElement = document.createElement('div');
                lineElement.className = `terminal-line ${line.type || ''}`;
                lineElement.innerHTML = line.text;
                terminal.appendChild(lineElement);
            });
            
            // Adicionar linha atual com prompt e input
            renderPrompt();
            
            // Rolar para o fim
            terminal.scrollTop = terminal.scrollHeight;
        }

        function renderPrompt() {
            const promptLine = document.createElement('div');
            promptLine.className = 'terminal-line';
            
            const currentTTY = ttys[currentState.currentTTY];
            const promptText = `${currentState.currentUser}@${currentState.hostname}:${getCurrentDirDisplay()}${currentState.currentUser === 'root' ? '#' : '$'} `;
            
            promptLine.innerHTML = `<span class="prompt">${promptText}</span>`;
            
            const inputSpan = document.createElement('span');
            inputSpan.innerHTML = currentInput;
            promptLine.appendChild(inputSpan);
            
            const cursor = document.createElement('span');
            cursor.className = 'blinking-cursor';
            promptLine.appendChild(cursor);
            
            terminal.appendChild(promptLine);
            
            // Evento de foco
            window.addEventListener('click', function() {
                cursor.classList.add('blinking-cursor');
            });
        }

        function getCurrentDirDisplay() {
            const currentDir = ttys[currentState.currentTTY].currentDir;
            
            // Se estivermos no diretório pessoal do usuário, exibir ~
            if (currentState.currentUser === 'root' && currentDir === '/root') {
                return '~';
            } else if (currentDir.startsWith('/home/' + currentState.currentUser)) {
                return '~' + currentDir.substring(('/home/' + currentState.currentUser).length);
            }
            
            return currentDir;
        }

        function addOutput(text, type = '') {
            const line = { text, type };
            ttys[currentState.currentTTY].output.push(line);
            
            // Limitar o histórico de saída para evitar uso excessivo de memória
            if (ttys[currentState.currentTTY].output.length > 1000) {
                ttys[currentState.currentTTY].output.shift();
            }
            
            renderTerminal();
            
            // Auto-salvar se ativado
            if (autoSave) {
                saveState();
            }
        }

        // Funções para manipulação de entrada
        function handleInput(event) {
            if (isExecuting) return;
            
            if (event.key === 'Enter') {
                const command = currentInput.trim();
                
                if (command) {
                    addOutput(`<span class="prompt">${currentState.currentUser}@${currentState.hostname}:${getCurrentDirDisplay()}${currentState.currentUser === 'root' ? '#' : '$'} </span>${command}`);
                    
                    // Adicionar ao histórico
                    inputHistory.push(command);
                    if (inputHistory.length > 100) inputHistory.shift();
                    historyPosition = inputHistory.length;
                    
                    // Executar comando
                    executeCommand(command);
                } else {
                    // Linha vazia, apenas mostrar outro prompt
                    addOutput('');
                }
                
                currentInput = '';
                inputPosition = 0;
            } else if (event.key === 'Backspace') {
                if (inputPosition > 0) {
                    currentInput = currentInput.substring(0, inputPosition - 1) + currentInput.substring(inputPosition);
                    inputPosition--;
                    renderTerminal();
                }
            } else if (event.key === 'Delete') {
                if (inputPosition < currentInput.length) {
                    currentInput = currentInput.substring(0, inputPosition) + currentInput.substring(inputPosition + 1);
                    renderTerminal();
                }
            } else if (event.key === 'ArrowLeft') {
                if (inputPosition > 0) {
                    inputPosition--;
                    renderTerminal();
                }
            } else if (event.key === 'ArrowRight') {
                if (inputPosition < currentInput.length) {
                    inputPosition++;
                    renderTerminal();
                }
            } else if (event.key === 'ArrowUp') {
                if (historyPosition > 0) {
                    historyPosition--;
                    currentInput = inputHistory[historyPosition];
                    inputPosition = currentInput.length;
                    renderTerminal();
                }
            } else if (event.key === 'ArrowDown') {
                if (historyPosition < inputHistory.length - 1) {
                    historyPosition++;
                    currentInput = inputHistory[historyPosition];
                    inputPosition = currentInput.length;
                    renderTerminal();
                } else if (historyPosition === inputHistory.length - 1) {
                    historyPosition = inputHistory.length;
                    currentInput = '';
                    inputPosition = 0;
                    renderTerminal();
                }
            } else if (event.key === 'Tab') {
                event.preventDefault();
                // Implementar auto-completar
                autocomplete();
            } else if (event.key === 'c' && event.ctrlKey) {
                if (isExecuting) {
                    // Interromper comando em execução
                    isExecuting = false;
                    addOutput('^C', 'error');
                    renderPrompt();
                } else {
                    // Limpar linha atual
                    currentInput = '';
                    inputPosition = 0;
                    addOutput('^C');
                    renderTerminal();
                }
            } else if (event.key === 'l' && event.ctrlKey) {
                // Clear screen
                ttys[currentState.currentTTY].output = [];
                renderTerminal();
            } else if (event.key.length === 1 && !event.ctrlKey && !event.altKey && !event.metaKey) {
                // Caractere normal
                currentInput = currentInput.substring(0, inputPosition) + event.key + currentInput.substring(inputPosition);
                inputPosition++;
                renderTerminal();
            }
            
            // ALT+F1 até ALT+F6 para mudar de TTY
            if (event.altKey && event.key.startsWith('F')) {
                const ttyNum = parseInt(event.key.substring(1));
                if (ttyNum >= 1 && ttyNum <= 6) {
                    switchTTY(ttyNum);
                }
            }
        }

        function autocomplete() {
            const args = currentInput.split(' ');
            const lastArg = args[args.length - 1];
            
            // Se começar com /, tentar completar caminhos
            if (lastArg.startsWith('/')) {
                // TODO: Implementar autocompletar de caminhos
            } else if (args.length === 1) {
                // Tentar completar comandos
                const possibleCommands = [
                    'ls', 'cd', 'pwd', 'cat', 'echo', 'mkdir', 'rm', 'cp', 'mv',
                    'whoami', 'apt', 'vi', 'vim', 'nano', 'clear', 'ip', 'reboot',
                    'poweroff', 'su', 'grep', 'find', 'chmod', 'chown', 'tty'
                ];
                
                const matches = possibleCommands.filter(cmd => cmd.startsWith(lastArg));
                
                if (matches.length === 1) {
                    // Um único comando encontrado
                    currentInput = matches[0];
                    inputPosition = currentInput.length;
                    renderTerminal();
                } else if (matches.length > 1) {
                    // Vários comandos, mostrar opções
                    addOutput('');
                    addOutput(matches.join('  '));
                    addOutput('');
                    renderPrompt();
                }
            }
        }

        // Funções para comandos
        function executeCommand(commandLine) {
            // Separar comando e argumentos
            const args = commandLine.split(' ');
            const command = args[0].toLowerCase();
            args.shift(); // Remove o comando dos argumentos
            
            isExecuting = true;
            
            // Simulação de tempo de execução
            setTimeout(() => {
                // Executar o comando correspondente
                switch (command) {
                    case 'ls':
                        cmdLs(args);
                        break;
                    case 'cd':
                        cmdCd(args);
                        break;
                    case 'pwd':
                        cmdPwd();
                        break;
                    case 'cat':
                        cmdCat(args);
                        break;
                    case 'whoami':
                        cmdWhoami();
                        break;
                    case 'tty':
                        cmdTty();
                        break;
                    case 'echo':
                        cmdEcho(args);
                        break;
                    case 'clear':
                        cmdClear();
                        break;
                    case 'mkdir':
                        cmdMkdir(args);
                        break;
                    case 'rm':
                        cmdRm(args);
                        break;
                    case 'cp':
                        cmdCp(args);
                        break;
                    case 'mv':
                        cmdMv(args);
                        break;
                    case 'ip':
                        cmdIp(args);
                        break;
                    case 'dhclient':
                        cmdDhclient(args);
                        break;
                    case 'apt':
                        cmdApt(args);
                        break;
                    case 'vi':
                    case 'vim':
                        cmdVim(args);
                        break;
                    case 'reboot':
                        cmdReboot();
                        break;
                    case 'poweroff':
                        cmdPoweroff();
                        break;
                    case 'su':
                        cmdSu(args);
                        break;
                    case 'hostname':
                        cmdHostname(args);
                        break;
                    default:
                        addOutput(`bash: ${command}: comando não encontrado`, 'error');
                        break;
                }
                
                isExecuting = false;
                
                // Não renderizar prompt para alguns comandos
                if (command !== 'clear' && command !== 'reboot' && command !== 'poweroff' && command !== 'vim' && command !== 'vi') {
                    renderPrompt();
                }
            }, Math.random() * 200); // Pequeno atraso aleatório para parecer mais realista
        }

        // Implementação de comandos
        function cmdLs(args) {
            let path = ttys[currentState.currentTTY].currentDir;
            let showHidden = false;
            let longFormat = false;
            
            // Processar opções
            for (let i = 0; i < args.length; i++) {
                if (args[i].startsWith('-')) {
                    if (args[i].includes('a')) showHidden = true;
                    if (args[i].includes('l')) longFormat = true;
                } else {
                    path = resolvePath(args[i]);
                }
            }
            
            // Obter o diretório alvo
            const targetDir = getDirectoryContents(path);
            
            if (!targetDir) {
                addOutput(`ls: não foi possível acessar '${path}': Arquivo ou diretório não encontrado`, 'error');
                return;
            }
            
            if (targetDir.type !== 'd') {
                addOutput(`ls: não foi possível acessar '${path}': Não é um diretório`, 'error');
                return;
            }
            
            // Listar conteúdo
            const entries = Object.keys(targetDir.content);
            
            if (entries.length === 0) {
                // Diretório vazio
                return;
            }
            
            // Filtrar arquivos ocultos se necessário
            const filteredEntries = showHidden ? entries : entries.filter(entry => !entry.startsWith('.'));
            
            if (longFormat) {
                // Formato longo (ls -l)
                filteredEntries.forEach(entry => {
                    const item = targetDir.content[entry];
                    
                    // Formato: tipo, permissões, links, proprietário, grupo, tamanho, data, nome
                    let size = item.type === 'd' ? 4096 : (item.content ? item.content.length : 0);
                    addOutput(`${item.permissions} 1 ${item.owner} ${item.group} ${size.toString().padStart(8)} ${item.date} ${entry}${item.type === 'd' ? '/' : ''}`);
                });
            } else {
                // Formato simples
                addOutput(filteredEntries.map(entry => {
                    const item = targetDir.content[entry];
                    return `${entry}${item.type === 'd' ? '/' : ''}`;
                }).join('  '));
            }
        }

        function cmdCd(args) {
            if (args.length === 0) {
                // cd sem argumentos vai para o diretório do usuário
                ttys[currentState.currentTTY].currentDir = currentState.currentUser === 'root' ? '/root' : `/home/${currentState.currentUser}`;
                return;
            }
            
            const targetPath = resolvePath(args[0]);
            const targetDir = getDirectoryContents(targetPath);
            
            if (!targetDir) {
                addOutput(`cd: ${args[0]}: Arquivo ou diretório não encontrado`, 'error');
                return;
            }
            
            if (targetDir.type !== 'd') {
                addOutput(`cd: ${args[0]}: Não é um diretório`, 'error');
                return;
            }
            
            ttys[currentState.currentTTY].currentDir = targetPath;
        }

        function cmdPwd() {
            addOutput(ttys[currentState.currentTTY].currentDir);
        }

        function cmdCat(args) {
            if (args.length === 0) {
                addOutput('cat: nenhum arquivo especificado', 'error');
                return;
            }
            
            const targetPath = resolvePath(args[0]);
            const targetFile = getDirectoryContents(targetPath);
            
            if (!targetFile) {
                addOutput(`cat: ${args[0]}: Arquivo ou diretório não encontrado`, 'error');
                return;
            }
            
            if (targetFile.type === 'd') {
                addOutput(`cat: ${args[0]}: É um diretório`, 'error');
                return;
            }
            
            // Exibir conteúdo do arquivo
            addOutput(targetFile.content);
        }

        function cmdWhoami() {
            addOutput(currentState.currentUser);
        }

        function cmdTty() {
            addOutput(`/dev/tty${currentState.currentTTY}`);
        }

        function cmdEcho(args) {
            // Processar simples substituições de variáveis
            const processedArgs = args.map(arg => {
                if (arg.startsWith('$')) {
                    const varName = arg.substring(1);
                    switch (varName) {
                        case 'USER':
                            return currentState.currentUser;
                        case 'HOME':
                            return currentState.currentUser === 'root' ? '/root' : `/home/${currentState.currentUser}`;
                        case 'HOSTNAME':
                            return currentState.hostname;
                        case 'PWD':
                            return ttys[currentState.currentTTY].currentDir;
                        default:
                            return '';
                    }
                }
                return arg;
            });
            
            // Verificar se é um redirecionamento
            const output = processedArgs.join(' ');
            const redirectIndex = args.indexOf('>');
            
            if (redirectIndex !== -1 && redirectIndex < args.length - 1) {
                // Redirecionamento
                const filePath = resolvePath(args[redirectIndex + 1]);
                const parentDir = getParentDirectory(filePath);
                const fileName = filePath.split('/').pop();
                
                if (!parentDir) {
                    addOutput(`echo: não foi possível redirecionar: diretório não encontrado`, 'error');
                    return;
                }
                
                // Criar ou sobrescrever arquivo
                parentDir.content[fileName] = {
                    type: '-',
                    permissions: '-rw-r--r--',
                    owner: currentState.currentUser,
                    group: currentState.currentUser,
                    content: processedArgs.slice(0, redirectIndex).join(' '),
                    date: getCurrentDate()
                };
            } else {
                // Exibição normal
                addOutput(output);
            }
        }

        function cmdClear() {
            ttys[currentState.currentTTY].output = [];
            renderTerminal();
        }

        function cmdMkdir(args) {
            if (args.length === 0) {
                addOutput('mkdir: operando em falta', 'error');
                addOutput('Tente \'mkdir --help\' para mais informações.', 'error');
                return;
            }
            
            const targetPath = resolvePath(args[0]);
            const parentDir = getParentDirectory(targetPath);
            const dirName = targetPath.split('/').pop();
            
            if (!parentDir) {
                addOutput(`mkdir: não foi possível criar o diretório '${args[0]}': Caminho não encontrado`, 'error');
                return;
            }
            
            if (parentDir.content[dirName]) {
                addOutput(`mkdir: não foi possível criar o diretório '${args[0]}': Arquivo existe`, 'error');
                return;
            }
            
            // Criar diretório
            parentDir.content[dirName] = {
                type: 'd',
                permissions: 'drwxr-xr-x',
                owner: currentState.currentUser,
                group: currentState.currentUser,
                content: {},
                date: getCurrentDate()
            };
        }

        function cmdRm(args) {
            if (args.length === 0) {
                addOutput('rm: operando em falta', 'error');
                addOutput('Tente \'rm --help\' para mais informações.', 'error');
                return;
            }
            
            let recursive = false;
            let force = false;
            let targetPaths = [];
            
            // Processar opções
            for (let i = 0; i < args.length; i++) {
                if (args[i].startsWith('-')) {
                    if (args[i].includes('r') || args[i].includes('R')) recursive = true;
                    if (args[i].includes('f')) force = true;
                } else {
                    targetPaths.push(args[i]);
                }
            }
            
            if (targetPaths.length === 0) {
                addOutput('rm: operando em falta', 'error');
                return;
            }
            
            // Processar cada caminho
            targetPaths.forEach(path => {
                const targetPath = resolvePath(path);
                const parentDir = getParentDirectory(targetPath);
                const fileName = targetPath.split('/').pop();
                
                if (!parentDir || !parentDir.content[fileName]) {
                    if (!force) {
                        addOutput(`rm: não foi possível remover '${path}': Arquivo ou diretório não encontrado`, 'error');
                    }
                    return;
                }
                
                const target = parentDir.content[fileName];
                
                if (target.type === 'd' && !recursive) {
                    addOutput(`rm: não foi possível remover '${path}': É um diretório`, 'error');
                    return;
                }
                
                // Remover arquivo ou diretório
                delete parentDir.content[fileName];
            });
        }

        function cmdCp(args) {
            if (args.length < 2) {
                addOutput('cp: faltando operando de arquivo', 'error');
                addOutput('Tente \'cp --help\' para mais informações.', 'error');
                return;
            }
            
            const sourcePath = resolvePath(args[0]);
            const destPath = resolvePath(args[1]);
            
            const sourceFile = getDirectoryContents(sourcePath);
            
            if (!sourceFile) {
                addOutput(`cp: não foi possível acessar '${args[0]}': Arquivo ou diretório não encontrado`, 'error');
                return;
            }
            
            const destParent = getParentDirectory(destPath);
            const destName = destPath.split('/').pop();
            
            if (!destParent) {
                addOutput(`cp: não foi possível criar arquivo regular '${args[1]}': Caminho não encontrado`, 'error');
                return;
            }
            
            // Cópia simples (sem recursão para diretórios)
            if (sourceFile.type === 'd') {
                addOutput(`cp: omitindo o diretório '${args[0]}'`, 'error');
                return;
            }
            
            // Criar uma cópia
            destParent.content[destName] = {
                ...sourceFile,
                owner: currentState.currentUser,
                group: currentState.currentUser,
                date: getCurrentDate()
            };
        }

        function cmdMv(args) {
            if (args.length < 2) {
                addOutput('mv: faltando operando de arquivo', 'error');
                addOutput('Tente \'mv --help\' para mais informações.', 'error');
                return;
            }
            
            const sourcePath = resolvePath(args[0]);
            const destPath = resolvePath(args[1]);
            
            const sourceParent = getParentDirectory(sourcePath);
            const sourceName = sourcePath.split('/').pop();
            
            if (!sourceParent || !sourceParent.content[sourceName]) {
                addOutput(`mv: não foi possível acessar '${args[0]}': Arquivo ou diretório não encontrado`, 'error');
                return;
            }
            
            const destParent = getParentDirectory(destPath);
            const destName = destPath.split('/').pop();
            
            if (!destParent) {
                addOutput(`mv: não foi possível mover para '${args[1]}': Caminho não encontrado`, 'error');
                return;
            }
            
            // Mover o arquivo/diretório
            destParent.content[destName] = sourceParent.content[sourceName];
            delete sourceParent.content[sourceName];
        }

        function cmdIp(args) {
            if (args.length === 0) {
                addOutput('Uso: ip [opções] OBJETO {COMANDO | help}', 'error');
                addOutput('OBJETO := { link | address | route | neigh }', 'error');
                return;
            }
            
            if (args[0] === 'address' || args[0] === 'addr' || args[0] === 'a') {
                if (args[1] === 'show' || args[1] === 's' || !args[1]) {
                    // Mostrar endereços IP
                    const showAll = !args[2];
                    const interfaces = Object.keys(currentState.networkInterfaces);
                    
                    interfaces.forEach(iface => {
                        if (showAll || args[2] === iface) {
                            const ifaceData = currentState.networkInterfaces[iface];
                            
                            if (iface === 'lo') {
                                addOutput(`1: ${iface}: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000`);
                                addOutput(`    inet ${ifaceData.address}/8 scope host lo`);
                                addOutput(`       valid_lft forever preferred_lft forever`);
                            } else {
                                addOutput(`2: ${iface}: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state ${ifaceData.status.toUpperCase()} group default qlen 1000`);
                                if (ifaceData.address) {
                                    addOutput(`    inet ${ifaceData.address}/24 brd 10.0.2.255 scope global dynamic ${iface}`);
                                    addOutput(`       valid_lft 86386sec preferred_lft 86386sec`);
                                }
                                addOutput(`    link/ether 08:00:27:a9:7d:${iface === 'enp0s3' ? '95' : 'ab'} brd ff:ff:ff:ff:ff:ff`);
                            }
                        }
                    });
                }
            } else {
                addOutput(`Objeto ${args[0]} não reconhecido.`, 'error');
            }
        }

        function cmdDhclient(args) {
            if (args.length === 0) {
                addOutput('Uso: dhclient [opções] interface', 'error');
                return;
            }
            
            const iface = args[args.length - 1];
            const verbose = args.includes('-v');
            
            if (!currentState.networkInterfaces[iface]) {
                addOutput(`Interface ${iface} não encontrada.`, 'error');
                return;
            }
            
            // Simular processo DHCP
            loadingElement.style.display = 'flex';
            
            setTimeout(() => {
                if (verbose) {
                    addOutput('Internet Systems Consortium DHCP Client 4.4.1');
                    addOutput('Copyright 2004-2018 Internet Systems Consortium.');
                    addOutput('All rights reserved.');
                    addOutput('For info, please visit https://www.isc.org/software/dhcp/');
                    addOutput('');
                    addOutput(`Listening on LPF/${iface}/08:00:27:a9:7d:ab`);
                    addOutput('Sending on   LPF/${iface}/08:00:27:a9:7d:ab');
                    addOutput(`Sending on   Socket/fallback`);
                    addOutput(`DHCPDISCOVER on ${iface} to 255.255.255.255 port 67 interval 3`);
                    addOutput(`DHCPREQUEST for 10.0.2.15 on ${iface} to 255.255.255.255 port 67`);
                    addOutput(`DHCPACK from 10.0.2.2`);
                    addOutput(`bound to 10.0.2.15 -- renewal in 42196 seconds.`);
                }
                
                // Atualizar configuração de rede
                currentState.networkInterfaces[iface] = {
                    status: 'up',
                    address: iface === 'enp0s3' ? '10.0.2.15' : '192.168.56.101',
                    netmask: '255.255.255.0'
                };
                
                loadingElement.style.display = 'none';
                renderPrompt();
            }, 3000);
        }

        function cmdApt(args) {
            if (args.length === 0) {
                addOutput('apt 2.6.1 (amd64)', 'success');
                addOutput('Uso: apt [opções] comando', 'success');
                return;
            }
            
            const command = args[0];
            
            if (command === 'update') {
                // Simular apt update
                loadingElement.style.display = 'flex';
                
                let progress = 0;
                const updateInterval = setInterval(() => {
                    if (progress < 100) {
                        progress += 10;
                        loadingElement.innerHTML = `<div>Atualizando... ${progress}%</div>`;
                    } else {
                        clearInterval(updateInterval);
                        loadingElement.style.display = 'none';
                        
                        addOutput('Obter:1 http://deb.debian.org/debian bookworm InRelease [151 kB]');
                        addOutput('Obter:2 http://deb.debian.org/debian bookworm/main amd64 Packages [9.262 kB]');
                        addOutput('Obter:3 http://security.debian.org/debian-security bookworm-security InRelease [48,0 kB]');
                        addOutput('Baixados 9.461 kB em 2s (4.731 kB/s)');
                        addOutput('Lendo listas de pacotes... Pronto');
                        
                        currentState.aptUpdated = true;
                        renderPrompt();
                    }
                }, 300);
            } else if (command === 'install') {
                if (args.length < 2) {
                    addOutput('E: Nenhum pacote foi especificado para instalação.', 'error');
                    return;
                }
                
                const packageName = args[1];
                
                if (!currentState.aptUpdated) {
                    addOutput('E: As listas de pacotes ou os arquivos de status não puderam ser analisados ou abertos.', 'error');
                    addOutput('Tente executar "apt update" primeiro.', 'error');
                    return;
                }
                
                if (!availablePackages[packageName]) {
                    addOutput(`E: Não foi possível encontrar o pacote ${packageName}`, 'error');
                    return;
                }
                
                if (currentState.installedPackages[packageName]) {
                    addOutput(`${packageName} já é a versão mais recente (${availablePackages[packageName].version}).`, 'success');
                    return;
                }
                
                // Simular instalação
                loadingElement.style.display = 'flex';
                
                setTimeout(() => {
                    addOutput(`Lendo listas de pacotes... Pronto`);
                    addOutput(`Construindo árvore de dependências... Pronto`);
                    addOutput(`Lendo informação de estado... Pronto`);
                    addOutput(`Os pacotes adicionais seguintes serão instalados:`);
                    
                    const dependencies = availablePackages[packageName].dependencies;
                    if (dependencies.length > 0) {
                        addOutput(`  ${dependencies.join(' ')}`);
                    }
                    
                    addOutput(`Os NOVOS pacotes seguintes serão instalados:`);
                    addOutput(`  ${packageName}${dependencies.length > 0 ? ' ' + dependencies.join(' ') : ''}`);
                    addOutput(`0 pacotes atualizados, ${1 + dependencies.length} pacotes novos instalados, 0 a serem removidos e 0 não atualizados.`);
                    addOutput(`Necessário obter ${availablePackages[packageName].size} de arquivos.`);
                    addOutput(`Depois desta operação, ${(parseFloat(availablePackages[packageName].size) * 2.5).toFixed(1)}MB adicionais de espaço em disco serão usados.`);
                    addOutput(`Obter:1 http://deb.debian.org/debian bookworm/main amd64 ${packageName} amd64 ${availablePackages[packageName].version} [${availablePackages[packageName].size}]`);
                    
                    let progress = 0;
                    const installInterval = setInterval(() => {
                        if (progress < 100) {
                            progress += 5;
                            loadingElement.innerHTML = `<div>Instalando ${packageName}... ${progress}%</div>`;
                        } else {
                            clearInterval(installInterval);
                            loadingElement.style.display = 'none';
                            
                            addOutput(`Baixados ${availablePackages[packageName].size} em 1s (${availablePackages[packageName].size}/s)`);
                            addOutput(`Selecionando pacote ${packageName} previamente não selecionado.`);
                            addOutput(`Preparando para desempacotar .../packages/${packageName}_${availablePackages[packageName].version}_amd64.deb...`);
                            addOutput(`Desempacotando ${packageName} (${availablePackages[packageName].version})...`);
                            addOutput(`Configurando ${packageName} (${availablePackages[packageName].version})...`);
                            addOutput(`Processando gatilhos para man-db (2.11.2-2)...`);
                            
                            // Marcar como instalado
                            currentState.installedPackages[packageName] = {
                                version: availablePackages[packageName].version,
                                installDate: getCurrentDate()
                            };
                            
                            // Marcar dependências como instaladas também
                            dependencies.forEach(dep => {
                                if (!currentState.installedPackages[dep]) {
                                    currentState.installedPackages[dep] = {
                                        version: availablePackages[dep].version,
                                        installDate: getCurrentDate()
                                    };
                                }
                            });
                            
                            renderPrompt();
                        }
                    }, 200);
                }, 1000);
            } else if (command === 'list' || command === 'list --installed') {
                if (Object.keys(currentState.installedPackages).length === 0) {
                    addOutput('Nenhum pacote instalado.');
                    return;
                }
                
                // Listar pacotes instalados
                addOutput('Lista de pacotes instalados:');
                Object.keys(currentState.installedPackages).forEach(pkg => {
                    const info = currentState.installedPackages[pkg];
                    addOutput(`${pkg}/${currentState.hostname} ${info.version} amd64 [instalado,local]`);
                });
            } else {
                addOutput(`Comando apt '${command}' não reconhecido.`, 'error');
            }
        }

        function cmdVim(args) {
            if (args.length === 0) {
                addOutput('uso: vim [argumentos] [arquivo ..]', 'error');
                return;
            }
            
            const filePath = resolvePath(args[0]);
            const parentDir = getParentDirectory(filePath);
            const fileName = filePath.split('/').pop();
            
            if (!parentDir) {
                addOutput(`vim: não foi possível editar '${args[0]}': Diretório não encontrado`, 'error');
                return;
            }
            
            // Verificar se vim está instalado
            if (!currentState.installedPackages['vim']) {
                addOutput(`bash: vim: comando não encontrado`, 'error');
                return;
            }
            
            // Limpar a tela para o editor
            ttys[currentState.currentTTY].output = [];
            
            // Interface simulada do Vim
            const fileContent = parentDir.content[fileName] ? parentDir.content[fileName].content : '';
            
            // Criar "editor" simulado
            activeEditor = {
                filePath: filePath,
                parentDir: parentDir,
                fileName: fileName,
                content: fileContent,
                saved: true
            };
            
            // Mostrar conteúdo no "editor"
            renderEditor();
        }

        function renderEditor() {
            terminal.innerHTML = '';
            
            // Mostrar conteúdo do arquivo
            const lines = activeEditor.content.split('\n');
            const headerLine = document.createElement('div');
            headerLine.className = 'terminal-line';
            headerLine.innerHTML = `"${activeEditor.fileName}" ${lines.length}L, ${activeEditor.content.length}C`;
            terminal.appendChild(headerLine);
            
            // Adicionar linhas com números
            lines.forEach((line, index) => {
                const lineElement = document.createElement('div');
                lineElement.className = 'terminal-line';
                lineElement.innerHTML = `${index + 1} ${line}`;
                terminal.appendChild(lineElement);
            });
            
            // Linha de status
            const statusLine = document.createElement('div');
            statusLine.className = 'terminal-line';
            statusLine.innerHTML = `<span style="background-color: #333; color: white; width: 100%; display: block; padding: 2px 5px;">"${activeEditor.fileName}" ${lines.length}L, ${activeEditor.content.length}C${activeEditor.saved ? '' : ' [+]'}</span>`;
            terminal.appendChild(statusLine);
            
            // Linha de comando
            const cmdLine = document.createElement('div');
            cmdLine.className = 'terminal-line';
            cmdLine.innerHTML = `<span>:</span><span class="blinking-cursor"></span>`;
            terminal.appendChild(cmdLine);
            
            // Instruções
            const instructionsLine = document.createElement('div');
            instructionsLine.className = 'terminal-line';
            instructionsLine.innerHTML = `<span style="color: #888;">[Pressione ESC, digite :wq e pressione ENTER para salvar e sair]</span>`;
            terminal.appendChild(instructionsLine);
        }

        function handleEditorInput(event) {
            if (event.key === 'Escape') {
                // Entrar no modo de comando
                const cmdLine = terminal.querySelector('.terminal-line:nth-last-child(2)');
                cmdLine.innerHTML = `<span>:</span><span class="blinking-cursor"></span>`;
                currentInput = '';
                inputPosition = 0;
            } else if (event.key === 'Enter' && currentInput === ':wq') {
                // Salvar e sair
                saveEditorContent();
                activeEditor = null;
                ttys[currentState.currentTTY].output = [];
                renderTerminal();
            } else if (event.key === 'Enter' && currentInput === ':q!') {
                // Sair sem salvar
                activeEditor = null;
                ttys[currentState.currentTTY].output = [];
                renderTerminal();
            } else if (currentInput.startsWith(':') && event.key.length === 1) {
                // Adicionar à linha de comando
                currentInput += event.key;
                const cmdLine = terminal.querySelector('.terminal-line:nth-last-child(2)');
                cmdLine.innerHTML = `<span>:${currentInput.substring(1)}</span><span class="blinking-cursor"></span>`;
            }
        }

        function saveEditorContent() {
            const parentDir = activeEditor.parentDir;
            const fileName = activeEditor.fileName;
            
            // Atualizar ou criar arquivo
            if (parentDir.content[fileName]) {
                parentDir.content[fileName].content = activeEditor.content;
                parentDir.content[fileName].date = getCurrentDate();
            } else {
                parentDir.content[fileName] = {
                    type: '-',
                    permissions: '-rw-r--r--',
                    owner: currentState.currentUser,
                    group: currentState.currentUser,
                    content: activeEditor.content,
                    date: getCurrentDate()
                };
            }
        }

        function cmdReboot() {
            addOutput('Reiniciando sistema...');
            
            loadingElement.style.display = 'flex';
            loadingElement.innerHTML = '<div class="spinner"></div><div style="margin-left: 10px;">Reiniciando...</div>';
            
            setTimeout(() => {
                ttys[currentState.currentTTY].output = [];
                loadingElement.style.display = 'none';
                bootSystem();
                
                // Atualizar tempo de inicialização
                currentState.bootTime = new Date().getTime();
            }, 3000);
        }

        function cmdPoweroff() {
            addOutput('Desligando sistema...');
            
            loadingElement.style.display = 'flex';
            loadingElement.innerHTML = '<div class="spinner"></div><div style="margin-left: 10px;">Desligando...</div>';
            
            setTimeout(() => {
                ttys[currentState.currentTTY].output = [];
                
                // Tela preta com mensagem
                terminal.innerHTML = '';
                loadingElement.style.display = 'none';
                
                const shutdownMsg = document.createElement('div');
                shutdownMsg.className = 'terminal-line';
                shutdownMsg.innerHTML = '<span>Sistema desligado. Clique em qualquer lugar para reiniciar.</span>';
                terminal.appendChild(shutdownMsg);
                
                // Quando clicar, reiniciar
                terminal.onclick = function() {
                    terminal.onclick = null;
                    bootSystem();
                    
                    // Atualizar tempo de inicialização
                    currentState.bootTime = new Date().getTime();
                };
            }, 3000);
        }

        function cmdSu(args) {
            const targetUser = args.length > 0 ? args[0] : 'root';
            
            if (!currentState.users[targetUser]) {
                addOutput(`su: usuário ${targetUser} não existe`, 'error');
                return;
            }
            
            // Trocar usuário
            currentState.currentUser = targetUser;
            
            // Se trocar para root, não precisa de senha
            // Em implementação real, pediriamos senha
            
            addOutput(``, 'success');
        }

        function cmdHostname(args) {
            if (args.length === 0) {
                // Exibir o hostname atual
                addOutput(currentState.hostname);
                return;
            }
            
            // Definir novo hostname
            if (currentState.currentUser !== 'root') {
                addOutput('hostname: você deve ser root para alterar o hostname do sistema', 'error');
                return;
            }
            
            currentState.hostname = args[0];
            
            // Atualizar o hostname no arquivo
            const hostnameFile = getDirectoryContents('/etc/hostname');
            if (hostnameFile) {
                hostnameFile.content = currentState.hostname;
            }
        }

        // Funções utilitárias
        function resolvePath(path) {
            // Caminho absoluto ou relativo
            let currentDir = ttys[currentState.currentTTY].currentDir;
            
            if (path.startsWith('/')) {
                return normalizePath(path);
            } else {
                return normalizePath(`${currentDir}/${path}`);
            }
        }

        function normalizePath(path) {
            // Normalizar caminho (remover .., ., barras extras)
            const parts = path.split('/').filter(p => p !== '');
            const result = [];
            
            for (let i = 0; i < parts.length; i++) {
                if (parts[i] === '..') {
                    result.pop();
                } else if (parts[i] !== '.') {
                    result.push(parts[i]);
                }
            }
            
            return '/' + result.join('/');
        }

        function getDirectoryContents(path) {
            if (path === '/') {
                return filesystem['/'];
            }
            
            const parts = path.split('/').filter(p => p !== '');
            let current = filesystem['/'];
            
            for (let i = 0; i < parts.length; i++) {
                if (!current || current.type !== 'd' || !current.content[parts[i]]) {
                    return null;
                }
                current = current.content[parts[i]];
            }
            
            return current;
        }

        function getParentDirectory(path) {
            const parts = path.split('/').filter(p => p !== '');
            
            if (parts.length === 0) {
                return null;
            }
            
            // Remover o último elemento (nome do arquivo/diretório)
            parts.pop();
            
            // Se não houver partes, é o diretório raiz
            if (parts.length === 0) {
                return filesystem['/'];
            }
            
            return getDirectoryContents('/' + parts.join('/'));
        }

        function getCurrentDate() {
            const now = new Date();
            const month = now.toLocaleString('default', { month: 'short' });
            const day = now.getDate().toString().padStart(2, '0');
            const time = now.toTimeString().substring(0, 5);
            return `${month} ${day} ${time}`;
        }

        // Funções para TTYs
        function switchTTY(ttyNum) {
            if (ttyNum < 1 || ttyNum > 6) return;
            
            currentState.currentTTY = ttyNum;
            
            // Atualizar botões
            ttyButtons.forEach(btn => {
                if (parseInt(btn.dataset.tty) === ttyNum) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            renderTerminal();
        }

        // Funções para salvar/carregar estado
        function saveState(name = null) {
            const savedName = name || `Sessão ${new Date().toLocaleString()}`;
            
            const stateToSave = {
                ttys: ttys,
                currentState: currentState,
                filesystem: filesystem,
                installedPackages: currentState.installedPackages,
                timestamp: new Date().getTime(),
                name: savedName
            };
            
            // Salvar no localStorage
            try {
                // Obter histórico existente
                let history = JSON.parse(localStorage.getItem('debianTerminalHistory') || '[]');
                
                // Adicionar nova sessão
                history.push({
                    name: savedName,
                    date: new Date().toLocaleString(),
                    timestamp: new Date().getTime(),
                    state: JSON.stringify(stateToSave)
                });
                
                // Limitar tamanho do histórico
                if (history.length > 10) {
                    history = history.slice(-10);
                }
                
                localStorage.setItem('debianTerminalHistory', JSON.stringify(history));
                
                if (autoSave) {
                    localStorage.setItem('debianTerminalState', JSON.stringify(stateToSave));
                }
                
                addOutput(`Sessão salva: ${savedName}`, 'success');
            } catch (e) {
                addOutput(`Erro ao salvar sessão: ${e.message}`, 'error');
            }
        }

        function loadStateFromHistory(historyItem) {
            try {
                const state = JSON.parse(historyItem.state);
                restoreState(state);
                historyModal.style.display = 'none';
                addOutput(`Sessão carregada: ${historyItem.name}`, 'success');
            } catch (e) {
                addOutput(`Erro ao carregar sessão: ${e.message}`, 'error');
            }
        }

        function restoreState(state) {
            // Restaurar estado
            ttys = state.ttys;
            currentState = state.currentState;
            filesystem = state.filesystem;
            
            renderTerminal();
        }

        function resetTerminal() {
            // Limpar todos os TTYs
            Object.keys(ttys).forEach(key => {
                ttys[key] = { history: [], currentDir: '/root', user: 'root', hostname: 'debian', output: [] };
            });
            
            // Redefinir estado
            currentState = {
                currentTTY: 1,
                networkInterfaces: {
                    lo: {
                        status: 'up',
                        address: '127.0.0.1',
                        netmask: '255.0.0.0'
                    },
                    enp0s3: {
                        status: 'up',
                        address: '10.0.2.15',
                        netmask: '255.255.255.0'
                    },
                    enp0s8: {
                        status: 'down',
                        address: '',
                        netmask: ''
                    }
                },
                runningProcesses: [],
                installedPackages: {},
                users: {
                    'root': {
                        password: 'x',
                        uid: 0,
                        gid: 0,
                        home: '/root',
                        shell: '/bin/bash'
                    },
                    'user': {
                        password: 'x',
                        uid: 1000,
                        gid: 1000,
                        home: '/home/user',
                        shell: '/bin/bash'
                    }
                },
                currentUser: 'root',
                hostname: 'debian',
                uptime: 0,
                bootTime: new Date().getTime(),
                kernel: {
                    version: '5.10.0-21-amd64',
                    status: 'running'
                },
                grub: {
                    status: 'healthy',
                    config: 'default'
                },
                aptUpdated: false
            };
            
            // Reinicializar sistema de arquivos
            filesystem = {
                '/': {
                    type: 'd',
                    permissions: 'drwxr-xr-x',
                    owner: 'root',
                    group: 'root',
                    content: {},
                    date: '2025-05-15 08:00'
                }
            };
            
            initializeFilesystem();
            
            // Reiniciar terminal
            bootSystem();
        }

        function showHistoryModal() {
            historyList.innerHTML = '';
            
            try {
                const history = JSON.parse(localStorage.getItem('debianTerminalHistory') || '[]');
                
                if (history.length === 0) {
                    historyList.innerHTML = '<div class="no-history">Nenhuma sessão salva encontrada.</div>';
                } else {
                    // Ordenar por data (mais recente primeiro)
                    history.sort((a, b) => b.timestamp - a.timestamp);
                    
                    history.forEach((item, index) => {
                        const historyItem = document.createElement('div');
                        historyItem.className = 'history-item';
                        
                        historyItem.innerHTML = `
                            <div class="history-name">${item.name}</div>
                            <div class="history-date">${item.date}</div>
                            <button class="delete-history" data-index="${index}">&times;</button>
                        `;
                        
                        historyItem.onclick = function(e) {
                            if (e.target.classList.contains('delete-history')) {
                                deleteHistoryItem(parseInt(e.target.dataset.index));
                            } else {
                                loadStateFromHistory(item);
                            }
                        };
                        
                        historyList.appendChild(historyItem);
                    });
                }
                
                historyModal.style.display = 'flex';
            } catch (e) {
                addOutput(`Erro ao carregar histórico: ${e.message}`, 'error');
            }
        }

        function deleteHistoryItem(index) {
            try {
                const history = JSON.parse(localStorage.getItem('debianTerminalHistory') || '[]');
                history.splice(index, 1);
                localStorage.setItem('debianTerminalHistory', JSON.stringify(history));
                
                // Atualizar modal
                showHistoryModal();
            } catch (e) {
                addOutput(`Erro ao excluir item do histórico: ${e.message}`, 'error');
            }
        }

        // Event listeners
        document.addEventListener('keydown', function(e) {
            if (activeEditor) {
                handleEditorInput(e);
            } else {
                handleInput(e);
            }
        });

        ttyButtons.forEach(btn => {
            btn.addEventListener('click', function() {
                switchTTY(parseInt(this.dataset.tty));
            });
        });

        autoSaveToggle.addEventListener('change', function() {
            autoSave = this.checked;
            localStorage.setItem('debianTerminalAutoSave', autoSave);
            
            if (autoSave) {
                saveState();
            }
        });

        saveBtn.addEventListener('click', function() {
            const name = prompt('Nome da sessão:', `Sessão ${new Date().toLocaleString()}`);
            if (name) {
                saveState(name);
            }
        });

        loadBtn.addEventListener('click', function() {
            showHistoryModal();
        });

        resetBtn.addEventListener('click', function() {
            if (confirm('Tem certeza que deseja resetar o terminal? Todas as alterações não salvas serão perdidas.')) {
                resetTerminal();
            }
        });

        closeModal.addEventListener('click', function() {
            historyModal.style.display = 'none';
        });

        window.addEventListener('click', function(e) {
            if (e.target === historyModal) {
                historyModal.style.display = 'none';
            }
        });

        // Atalhos de teclado para ALT+F1 a ALT+F6
        document.addEventListener('keydown', function(e) {
            if (e.altKey && e.key.startsWith('F')) {
                const ttyNum = parseInt(e.key.substring(1));
                if (ttyNum >= 1 && ttyNum <= 6) {
                    switchTTY(ttyNum);
                }
            }
        });
    </script>
</body>
</html>
